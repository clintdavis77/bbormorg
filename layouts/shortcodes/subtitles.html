<div class="row" id="readbutton">
        <div class="col-12 col-12-mobilep" style="text-align: center;">
                <a class="button alt small" onclick="setupSubtitles();"><i class="icon fas fa-glasses"></i>&nbsp;Read along with subtitles (experimental)</a>
        </div>
    </div>
<div class="row" id="subrow" style="display: none;">
    <div class="col-12 col-12-mobilep" id="subtitles">
    </div>
</div>

<script>

    
    var transcriptDate = "{{.Get "date" }}";
    var theDate = transcriptDate.split("-");
    var jsonUrl = "/transcript-data/" + theDate[0] + "/" + transcriptDate + ".json";
        var syncData;
        var audioPlayer = document.getElementById("player");


    function highlightWord() {
        //console.log("here");
        //console.log((audioPlayer.currentTime * 1000));
        //console.log(syncData.words[27].start);

        syncData.words.forEach(function (element, index) {
            subtitles.children[index].style.fontWeight = "";
            if ((audioPlayer.currentTime * 1000) >= element.start && (audioPlayer.currentTime * 1000) <= element.end) {
                subtitles.children[index].style.fontWeight = "700";
                //subtitles.children[index].scrollIntoView(false);
            }


        });
    }

    // ES6 code
    function throttled(delay, fn) {
        let lastCall = 0;
        return function (...args) {
            const now = (new Date).getTime();
            if (now - lastCall < delay) {
                return;
            }
            lastCall = now;
            return fn(...args);
        }
    }

    function createSubtitle() {
        fetch(jsonUrl).then(r => r.json()).then(function(response){
            syncData = response;
            var element;
            var subtitles = document.getElementById("subtitles");
            for (var i = 0; i < syncData.words.length; i++) {
                element = document.createElement('span');
                element.setAttribute("id", "c_" + i);
                element.setAttribute("title", syncData.words[i].confidence);
                if (syncData.words[i].confidence <= 0.94) {
                    element.style.fontStyle = "italic";
                }
                element.innerText = syncData.words[i].text + " ";
                subtitles.appendChild(element);
            }
        });
    }

    function setupSubtitles(date) {
        var readbutton = document.getElementById("readbutton");
        readbutton.style.display = "none";

        var subrow = document.getElementById("subrow");
        subrow.style.display = "";


        
        //console.log(data);
        
        //console.log(syncData);

        

        createSubtitle();




        //const myHander = (event) => {highlightWord();}
        const tHandler = throttled(250, highlightWord);

        audioPlayer.addEventListener("timeupdate", tHandler);





    };

    //setupSubtitles();
</script>

